# Checklist

ðŸŸ¨Use Terraform
ðŸŸ¥Use Makefile
ðŸŸ©Setup Jenkins for CI/CD
ðŸŸ¨Build AMI using packer
ðŸŸ¥Build a BASE AMI that is used to build all other AMIs
Whenever a new base AMI is released (built), other AMI builds are triggered automatically
ðŸŸ¨Use lambda function to check source AMI and trigger Jenkins pipelines
ðŸŸ¨Create EFS: as persistant data storage, store source code or app data permanently

ðŸŸ¥App (3-tier model)
Flask API
user-data: Auto mount EFS
Run Docker Compose
Use Boto3, pandas(export CSV)... to export non-compliance security groups (Webpage > Click a button > List URLs to download CSV files)
ðŸŸ¥Store CSV lists to DB
App pipelines:

- Build Docker image â†’ ECR
- ðŸŸ¥ Use SonarQube to scan Docker image
- ðŸŸ¥ Deploy new app version
- ðŸŸ¥ Patching with new base AMI

ðŸŸ¨Tagging resources with required tags
Group: CyberDevOps
Environment: development

ðŸŸ¨AWS Config:
Rule to check tag compliance
Rule to check SG rule compliance
ðŸŸ¨SNS: send monitoring alerts (CPU, memory, disk)
ðŸŸ¨DNS (Route53)
ðŸŸ¨ALB
ðŸŸ¨ASG
ðŸŸ¨RDS
ðŸŸ¨S3 (CSV files)
ðŸŸ¨Encrypted with KMS key

### Notes

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)
- Jenkins seedjob flow: JCasC -> Seed Job -> External Job DSLs -> Job groovy scripts
- Terraform ECR Public gets `400` cannot delete if it has images, but can delete whole registry using console
- https://www.reddit.com/r/aws/comments/1ax2zv4/regional_data_transfer_usage_generated_by_ubuntu/
- https://aws.amazon.com/vpc/faqs/#:~:text=two%20instances%20communicate%20using%20public%20IP
- yum mirrors may deny access from some IPs/regions like `seoul`, best to use `sydney` or `singapore`
- AWS's AMI has package mananger source set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound: https://www.reddit.com/r/aws/comments/17s1jsd/comment/ksui2rn/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button

#### Mock Latest AMI Route

- Use an S3 static website

#### Lambda AMI Check

- EventBridge rule triggers Lambda function at some interval
- Lambda check for compare the lasest AMI-ID with the current one (stored on SSM Parameter Store)
- If new AMI-ID is found, trigger Jenkins job to build new AMI and update the SSM Parameter Store

#### EFS + DockerCompose?

- UserData Script to clone github repo and run docker compose -> Pull and run image from ECR
- Docker compose mount EFS volume to store data/logs??? =>Not as good as CloudWatch Logs

```yaml
# Example
version: "3"
services:
  web:
    image: my-web-app:latest
    environment:
      - DATABASE_URL=postgres://user:password@my-rds-endpoint:5432/mydatabase
    volumes:
      - efs:/var/www/html

volumes:
  efs:
    driver: local
    driver_opts:
      type: nfs
      o: addr=my-efs-endpoint,nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
      device: :/
```

#### Terraform

- 2 projects ????
  - Jenkins with Lambda, Eventbridge
  - App: ASG, ALB, RDS, Config, EFS, S3, CloudWatch

#### Patch ASG

- Update Launch_template with the new AMI??

#### Build BaseAMI:

- Build from local machine
- Packer: Build AMI from centos9, publish AMI and change S3 /images/aws/centos/latest to the new AMI-ID

#### Journal

This documents the progress of SC5 and the things I learned along the way.

â¬œâœ…â˜‘

TODO: Add SAA Learning


| Date        | Plan                                                                                                           | What I Did                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ----------- | -------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Mon, Apr 1  | â˜‘Overview of the lab3's requirements<br />â˜‘Refactor the network_interface of the ec2 instances               | - Remove all the custom `aws_network_interface` resources                                                                                                                                                                                                                                                                                                                                                                                                                                            | - The `aws_instance` by default creates a new ENI for itself, and also receive parameters like `subnet_id`, `security_groups`, `source_dest_check` to configure its ENI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Tue, Apr 2  |                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Wed, Apr 3  | â˜‘Refactor VPC modules into one<br />â˜‘Automate setting up a Jenkins server<br />â˜‘Try out Packer build        | - Merge the `vpc_with_nat_instance`Â module into the general `vpc` module.<br />- Write terraform to provision EC2 server for Jenkins<br />- Write user-data script to install Jenkins, plugins and add admin user with JCasC.<br />- Write a `jenkins.pkr.hcl` packer file to build an AMI with Jenkins from a base AMI.<br />- Install `job-dsl` plugin and write a simple seed job.<br />- Config seed job to generate jobs using dsl from git repo                                         | - You can conditionally choose to add a terraform resource or not by setting the count to 0 or 1.<br />The tradeoff is that the more you want to customize, the more variables should be added, and the logic is harder to control.<br />- All the Jenkins settingsÂ can be managed in a yaml configuration file using the JCasC plugin.<br />- Instead of directly changing `jenkin.service` systemd file, you can override the config by creating a new file `jenkins.service.d/overrides.conf`<br />- `job-dsl`: Config job using code, job-dsl api page auto reads api of other plugins too.<br />- `startup-trigger-plugin`: Add build trigger to start job on Jenkins startup.<br />- Seed job flow: Jenkins starts -> Load JCasC -> Generate and run seed job `bootstrap` -> Clone repo and run dsl files in `jenkins_jobs` folder to generate jobs/pipelines. (Separate dsl file and pipeline groovy file)) |
| Thu, Apr 4  | â˜‘Init Python app<br />â˜‘Test Jenkins with packer                                                              | - Create a simple Flask server and run it<br />- Write terraform resources to create EFS<br />- Write a simple job in Jenkins to build jenkins.pkr.hcl<br />- Add packer needed policies to ec2_jenkins_role                                                                                                                                                                                                                                                                                           | - Flask has `--debug` flag for hot reload<br />- Jenkins plugin `ansi-color`: Console Output with color<br />- RHEL and Centos has a binary in PATH that is coincidentally also named `packer` , so I have to move it away to use packer by Hashicorp<br />- `hash -r` command: clear the hash table, which `which` command uses                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Fri, Apr 5  | â˜‘Add lab3's diagram<br />â˜‘Dockerize the python app                                                           | - Add a overview diagram of lab3Â with all the services<br />- Create a public ECR registry<br />- Write Dockerfile and docker-compose.yml<br />- Manually upload docker image to registry                                                                                                                                                                                                                                                                                                             | -Â Terraform ECR Public gets code 400 cannot delete registry if it has images, but you can delete whole registry manually using console.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Sat, Apr 6  |                                                                                                                | - Registered for the SAA exam on Monday, 08/04/2024                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Mon, Apr 8  | â˜‘Review and Take SAA test                                                                                     | - Review the practice exams, notes.<br />- Sit the test in the afternoon. Got result at night, passed with the score of 853.                                                                                                                                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Tue, Apr 9  | â˜‘Finish lab2<br />â˜‘Connect lab3 app to mock SQLite db                                                        | - Lab2: Limit SG rules, add tags to resources<br />- Change AMI used to CentOS-Stream-9<br />- AddÂ DynamoDB state lock in terraform.<br />- Refactor ec2_profile into a module.<br />- Add flask_sqlalchemy to the app.                                                                                                                                                                                                                                                                               | - To use `ip route add`Â to route through NAT Instance, the NAT Instance must have another network interface (with source-dest-check off) inside the **same subnet** as the EC2 instance.<br />- RHEL AMIÂ has package mananger repoÂ set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound => Good to know but should not matter that much.<br />-Â The `http_proxy` environment variable is a way to tell applications that they should use a specific proxy server when making HTTP requests. However, it's up to each individual application to respect this setting.                                                                                                                                                                                                                                                                         |
| Wed, Apr 10 | â˜‘Add EventBridge + Lambda triggering Jenkins job<br />â˜‘Jenkins job to build and publish Docker image.        | - Try to mock HIPÂ HTTP route `/images/aws/centos/latest` using API Gateway REST API => HardÂ to setup/modify<br />=>Â Decided to useÂ S3 static website and custom domain name.<br />- Write Lambda function to compare the latest AMI and the current AMI, trigger Jenkins build if different.<br />- Write terraform resources for EventBridge to trigger Lambda at some interval.<br />- Move Python app to a separate git repo.<br />- Add PythonAppCI job to build, tag and push image to ECR. | - Jenkins `build-token-root` plugin: Trigger job build through an URL with token without authenticatingÂ user.<br />- Jenkins does not support Subfolder git tracking by default, so moved app to a different repo to manage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Thu, Apr 11 | â˜‘Integrate Jenkins with SonarQube<br />â˜‘Add SonarQubeÂ to App CI pipeline<br />â¬œ~Add terraform AWS Config~ | - Registered for a SonarCloud server, add a new project, generate a user token.<br />- Install the SonarQube Scanner plugin, config with JCasC<br />- Add sonar-scanner to app pipeline.<br />- Add packer file to build mockÂ HIP Base AMI.<br />- Move Jenkins to default region VPC.<br />- Write terraform resources for AWS Config. Currently not working, enabling Recorder hangs.                                                                                                               | - The AMI build flow:Â HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)<br />- Packer has `post-processor` to run command => Read created ami-id and push to S3 mock HIP server.<br />- AWS Config in terraform:Â `Recorder` needs `Delivery channel` to start, but `Delivery channel` needs `Recorder` to be created.Â => `aws_config_configuration_recorder_status`                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Fri, Apr 12 | â˜‘Review and demo Lab2<br />â˜‘Setup React frontend for app                                                     | - Init React client with tailwind.<br />- Flask to serve static files generated by React build.                                                                                                                                                                                                                                                                                                                                                                                                        | - If you use proxy environments like `HTTP_PROXY` on EC2, set `NO_PROXY` to include `169.254.169.254` for IMDS access.<br />- `traceroute` on linux uses UDP by default, but can be switched to using ICMP ECHO using `-I` option.<br />- App Development: 2 servers React and Flask API.<br />- App Deploy: Flask serves bothÂ React static file and API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| Mon, Apr 15 | â¬œAdd terraform AWS Config                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | - Configuration Recorder records configs changes and creates a Configuration ItemÂ for each change. 1 change == 1 CI<br />- Rules useÂ CI to evaluate compliance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
