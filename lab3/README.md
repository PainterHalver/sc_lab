# Checklist

ðŸŸ©Use Terraform
ðŸŸ¥Use Makefile
ðŸŸ©Setup Jenkins for CI/CD
ðŸŸ©Build AMI using packer
ðŸŸ©Build a BASE AMI that is used to build all other AMIs
Whenever a new base AMI is released (built), other AMI builds are triggered automatically
ðŸŸ¨Use lambda function to check source AMI and trigger Jenkins pipelines
ðŸŸ¨Create EFS: as persistant data storage, store source code or app data permanently

ðŸŸ¨App (3-tier model)
Flask API
user-data: Auto mount EFS
Run Docker Compose
Use Boto3, pandas(export CSV)... to export non-compliance security groups (Webpage > Click a button > List URLs to download CSV files)
ðŸŸ¨Store CSV lists to DB
App pipelines:

- Build Docker image â†’ ECR
- ðŸŸ¨ Use SonarQube to scan Docker image
- ðŸŸ¥ Deploy new app version
- ðŸŸ¥ Patching with new base AMI

ðŸŸ©Tagging resources with required tags
Group: CyberDevOps
Environment: development

ðŸŸ¨AWS Config:
Rule to check tag compliance
Rule to check SG rule compliance
ðŸŸ¨SNS: send monitoring alerts (CPU, memory, disk)
ðŸŸ¨DNS (Route53)
ðŸŸ¨ALB
ðŸŸ¨ASG
ðŸŸ¨RDS
ðŸŸ©S3 (CSV files)
ðŸŸ¨Encrypted with KMS key

### Notes

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)
- Jenkins seedjob flow: JCasC -> Seed Job -> External Job DSLs -> Job groovy scripts
- Terraform ECR Public gets `400` cannot delete if it has images, but can delete whole registry using console
- https://www.reddit.com/r/aws/comments/1ax2zv4/regional_data_transfer_usage_generated_by_ubuntu/
- https://aws.amazon.com/vpc/faqs/#:~:text=two%20instances%20communicate%20using%20public%20IP
- yum mirrors may deny access from some IPs/regions like `seoul`, best to use `sydney` or `singapore`
- AWS's AMI has package mananger source set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound: https://www.reddit.com/r/aws/comments/17s1jsd/comment/ksui2rn/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button

#### EFS + DockerCompose?

- UserData Script to clone github repo and run docker compose -> Pull and run image from ECR
- Docker compose mount EFS volume to store data/logs??

```yaml
# Example
version: "3"
services:
  web:
    image: my-web-app:latest
    environment:
      - DATABASE_URL=postgres://user:password@my-rds-endpoint:5432/mydatabase
    volumes:
      - efs:/var/www/html

volumes:
  efs:
    driver: local
    driver_opts:
      type: nfs
      o: addr=my-efs-endpoint,nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
      device: :/
```

#### Some questions:

- What exactly will EFS store?
- Should I mount EFS directly to container using docker compose or mount it to EC2 instance?
- What metrics/logs should CloudWatch monitor? And when to alert?
- Can Jenkins be deployed in the default VPC?
- When new code is pushed, do we build a new AMI and create new launch_template or just push code to the running instances?
- Do we have to run a SonarQube server? Can we use free SonarCloud server instead?
- Do we have to register a new domain in Route53?
- What will be the usecase of Makefile?
- What AMIs aside from the app AMI should we build from the Base AMI?

#### Mock latest AMI Route

- Route: `/images/aws/centos/latest` returns text/plain the ami-id of the latest HIP AMI.
- Use an S3 static website (manually, not using terraform).
- Point a domain to the site.

#### Mock new build of HIP AMI:

- Build from local machine.
- Packer: Build AMI from centos9, publish AMI and change S3 /images/aws/centos/latest to the new AMI-ID.

#### AMI Build Flow:

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> Other AMIs (Triggered after BASE AMI)

#### Lambda AMI Check

- EventBridge rule triggers Lambda function at some interval.
- Lambda check for compare the lasest AMI-ID with the current one (stored on SSM Parameter Store).
- If new AMI-ID is found, trigger Jenkins job to build new Base AMI and update the SSM Parameter Store.

#### Terraform

- Create 2 projects:
  - Jenkins with Lambda, Eventbridge.
  - App: ASG, ALB, RDS, Config, EFS, S3, CloudWatch.

#### How to patch app ASG

- Update launch_template with the new AMI??

#### How can app get data about RDS URL, bucketname?

- Using Parameter Store??

#### Jenkins BuildBaseAMI Flow

![build-base-ami-flow](../diagrams/lab-3-build-base-ami.png)

#### Other Ideas?

- [X] Write a script to delete all AMIs.
- [ ] Config Nginx point to React static and Gunicorn dynamic? [Gunicorn docs](https://docs.gunicorn.org/en/stable/deploy.html)
- [ ] Mount an EBS volume to persist /jenkins_home data, patch Jenkins master using agent.

#### Journal

This documents the progress and things I learned along the way.

â¬œâœ…

| Date        | Plan                                                                                                                               | What I Did                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Mon, Apr 1  | âœ…Overview of the lab3's requirements<br />âœ…Refactor the network_interface of the ec2 instances                                   | - Remove all the custom `aws_network_interface` resources                                                                                                                                                                                                                                                                                                                                                                                                                                            | - The `aws_instance` by default creates a new ENI for itself, and also receive parameters like `subnet_id`, `security_groups`, `source_dest_check` to configure its ENI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Tue, Apr 2  | âœ…Learn SAA, do practice tests                                                                                                     | - Review SAA learning notes<br />- Review practice tests on udemy<br />- Take official practice exam on SkillBuilder, got 87%                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Wed, Apr 3  | âœ…Refactor VPC modules into one<br />âœ…Automate setting up a Jenkins server<br />âœ…Try out Packer build                            | - Merge the `vpc_with_nat_instance`Â module into the general `vpc` module.<br />- Write terraform to provision EC2 server for Jenkins<br />- Write user-data script to install Jenkins, plugins and add admin user with JCasC.<br />- Write a `jenkins.pkr.hcl` packer file to build an AMI with Jenkins from a base AMI.<br />- Install `job-dsl` plugin and write a simple seed job.<br />- Config seed job to generate jobs using dsl from git repo                                         | - You can conditionally choose to add a terraform resource or not by setting the count to 0 or 1.<br />The tradeoff is that the more you want to customize, the more variables should be added, and the logic is harder to control.<br />- All the Jenkins settingsÂ can be managed in a yaml configuration file using the JCasC plugin.<br />- Instead of directly changing `jenkin.service` systemd file, you can override the config by creating a new file `jenkins.service.d/overrides.conf`<br />- `job-dsl`: Config job using code, job-dsl api page auto reads api of other plugins too.<br />- `startup-trigger-plugin`: Add build trigger to start job on Jenkins startup.<br />- Seed job flow: Jenkins starts -> Load JCasC -> Generate and run seed job `bootstrap` -> Clone repo and run dsl files in `jenkins_jobs` folder to generate jobs/pipelines. (Separate dsl file and pipeline groovy file)) |
| Thu, Apr 4  | âœ…Init Python app<br />âœ…Test Jenkins with packer                                                                                  | - Create a simple Flask server and run it<br />- Write terraform resources to create EFS<br />- Write a simple job in Jenkins to build jenkins.pkr.hcl<br />- Add packer needed policies to ec2_jenkins_role                                                                                                                                                                                                                                                                                           | - Flask has `--debug` flag for hot reload<br />- Jenkins plugin `ansi-color`: Console Output with color<br />- RHEL and Centos has a binary in PATH that is coincidentally also named `packer` , so I have to move it away to use packer by Hashicorp<br />- `hash -r` command: clear the hash table, which `which` command uses                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Fri, Apr 5  | âœ…Add lab3's diagram<br />âœ…Dockerize the python app                                                                               | - Add a overview diagram of lab3Â with all the services<br />- Create a public ECR registry<br />- Write Dockerfile and docker-compose.yml<br />- Manually upload docker image to registry                                                                                                                                                                                                                                                                                                             | -Â Terraform ECR Public gets code 400 cannot delete registry if it has images, but you can delete whole registry manually using console.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Sat, Apr 6  |                                                                                                                                    | - Registered for the SAA exam on Monday, 08/04/2024                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Mon, Apr 8  | âœ…Review and Take SAA test                                                                                                         | - Review the practice exams, notes.<br />- Sit the test in the afternoon. Got result at night, passed with the score of 853.                                                                                                                                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Tue, Apr 9  | âœ…Finish lab2<br />âœ…Connect lab3 app to mock SQLite db                                                                            | - Lab2: Limit SG rules, add tags to resources<br />- Change AMI used to CentOS-Stream-9<br />- AddÂ DynamoDB state lock in terraform.<br />- Refactor ec2_profile into a module.<br />- Add flask_sqlalchemy to the app.                                                                                                                                                                                                                                                                               | - To use `ip route add`Â to route through NAT Instance, the NAT Instance must have another network interface (with source-dest-check off) inside the **same subnet** as the EC2 instance.<br />- RHEL AMIÂ has package mananger repoÂ set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound => Good to know but should not matter that much.<br />-Â The `http_proxy` environment variable is a way to tell applications that they should use a specific proxy server when making HTTP requests. However, it's up to each individual application to respect this setting.                                                                                                                                                                                                                                                                         |
| Wed, Apr 10 | âœ…Add EventBridge + Lambda triggering Jenkins job<br />âœ…Jenkins job to build and publish Docker image.                            | - Try to mock HIPÂ HTTP route `/images/aws/centos/latest` using API Gateway REST API => HardÂ to setup/modify<br />=>Â Decided to useÂ S3 static website and custom domain name.<br />- Write Lambda function to compare the latest AMI and the current AMI, trigger Jenkins build if different.<br />- Write terraform resources for EventBridge to trigger Lambda at some interval.<br />- Move Python app to a separate git repo.<br />- Add PythonAppCI job to build, tag and push image to ECR. | - Jenkins `build-token-root` plugin: Trigger job build through an URL with token without authenticatingÂ user.<br />- Jenkins does not support Subfolder git tracking by default, so moved app to a different repo to manage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Thu, Apr 11 | âœ…Integrate Jenkins with SonarQube<br />âœ…Add SonarQubeÂ to App CI pipeline<br />â¬œ~Add terraform AWS Config~                     | - Registered for a SonarCloud server, add a new project, generate a user token.<br />- Install the SonarQube Scanner plugin, config with JCasC<br />- Add sonar-scanner to app pipeline.<br />- Add packer file to build mockÂ HIP Base AMI.<br />- Move Jenkins to default region VPC.<br />- Write terraform resources for AWS Config. Currently not working, enabling Recorder hangs.                                                                                                               | - The AMI build flow:Â HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)<br />- Packer has `post-processor` to run command => Read created ami-id and push to S3 mock HIP server.<br />- AWS Config in terraform:Â `Recorder` needs `Delivery channel` to start, but `Delivery channel` needs `Recorder` to be created.Â <br />=> `aws_config_configuration_recorder_status` resource set to true to enable recorder                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Fri, Apr 12 | âœ…Review and demo Lab2<br />âœ…Setup React frontend for app                                                                         | - Init React client with tailwind.<br />- Flask to serve static files generated by React build.                                                                                                                                                                                                                                                                                                                                                                                                        | - If you use proxy environments like `HTTP_PROXY` on EC2, set `NO_PROXY` to include `169.254.169.254` for IMDS access.<br />- `traceroute` on linux uses UDP by default, but can be switched to using ICMP ECHO using `-I` option.<br />- App Development: 2 servers React and Flask API.<br />- App Deploy: Flask serves bothÂ React static file and API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| Mon, Apr 15 | âœ…Document the notes<br />âœ…Add terraform AWS Config, S3 for app<br />âœ…Use boto3 to call configservice api                        | - Build and add course learning notes to github pages using Docusaurus.<br />- Add needed policies for AWS Config to use S3 bucket.<br />- Use boto3 to: Get all the SG in a region, check compliance status with AWS Config, export to CSV files and upload to S3, generate presigned URLs to download.<br />- Integrate into the Flask API.<br />- Create React frontend to consume API.                                                                                                             | - Configuration Recorder records configs changes and creates a Configuration ItemÂ for each change. 1 change == 1 CI<br />- Rules useÂ CI to evaluate compliance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Tue, Apr 16 | âœ…Dockerize Python app with API and Web<br />âœ…Draw the flow of the pipeline build BaseAMI<br />âœ…Write a script to delete all AMI | - Update Dockerfile, use multi-stage to build React web, copy static files to python app.<br />- Add `.dockerignore` node_modules, build to reduce image size.<br />- Add diagram for Jenkins Job: BuildBaseAMI<br />- Write job BuildBaseAMI in Jenkins. Trigger with Lambda.                                                                                                                                                                                                                       | - In .gitignore, a relative path (e.g.`filename`) matches the path under any directory, while in .dockerignore it's `**/filename`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Wed, Apr 17 | âœ…Find a way to run Jenkins with master + agent setup                                                                              | - Add Jenkins Amazon EC2 plugin, config to auto spawn agent.<br />- Dump config to JCasC.                                                                                                                                                                                                                                                                                                                                                                                                              | - EC2 plugin requires correct AWS Key Pair format ("-----BEGIN RSA PRIVATE KEY-----")<br />`aws ec2 create-key-pair --key-name my-key-pair --key-type rsa --key-format pem --query "KeyMaterial" --output text > my-key-pair.pem`<br />- Generate public key from private key with `ssh-keygen -y [-f input_keyfile]`<br />- You can addÂ label to nodes, and then specify label in job to run on which node.<br />- You can config EC2 so that there is always a number of instances standing by waiting for jobs.                                                                                                                                                                                                                                                                                                                                                                                                         |
| Fri, Apr 19 | â¬œStart writing terraform for Python App infrastructure                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
