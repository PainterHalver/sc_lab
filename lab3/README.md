# Checklist

### Old Requirements

ðŸŸ©Use Terraform
ðŸŸ¥Use Makefile
ðŸŸ©Setup Jenkins for CI/CD
ðŸŸ©Build AMI using packer
ðŸŸ©Build a BASE AMI that is used to build all other AMIs
Whenever a new base AMI is released (built), other AMI builds are triggered automatically
ðŸŸ©Use lambda function to check source AMI and trigger Jenkins pipelines
ðŸŸ¨Create EFS: as persistant data storage, store source code or app data permanently

ðŸŸ¨App (3-tier model)
Flask API
user-data: Auto mount EFS
Run Docker Compose
Use Boto3, pandas(export CSV)... to export non-compliance security groups (Webpage > Click a button > List URLs to download CSV files)
ðŸŸ©Store CSV lists to DB
App pipelines:

- Build Docker image â†’ ECR
- ðŸŸ¨ Use SonarQube to scan source code.
- ðŸŸ¨ Deploy new app version
- ðŸŸ¨ Patching with new base AMI

ðŸŸ©Tagging resources with required tags
Group: CyberDevOps
Environment: development

ðŸŸ©AWS Config:
Rule to check tag compliance
Rule to check SG rule compliance
ðŸŸ¨SNS: send monitoring alerts (CPU, memory, disk)
ðŸŸ¨DNS (Route53)
ðŸŸ©ALB
ðŸŸ©ASG
ðŸŸ©RDS
ðŸŸ©S3 (CSV files)
ðŸŸ¨Encrypted with KMS key

### New Requirements

Use Terraform

- ðŸŸ¨Build a pipeline to run terraform
- ðŸŸ¨Dry-Run mode: True/False
  ðŸŸ¨Use Makefile: To simplify command execution and automate repetitive tasks
  Infrastructure:
- ðŸŸ©Use one VPC
- ðŸŸ©Jenkins for CI/CD: 1
  - ðŸŸ©SonarScanner CLI
- ðŸŸ©jumphost: 1
- ðŸŸ©app (Docker Compose on EC2)
- ðŸŸ©Use ASG, LB
- ðŸŸ©RDS DB: Store non-compliant resource data (CSV info)
- ðŸŸ©SonarQube server: 1
- Create EFS: As persistant data storage
  - ðŸŸ©home dir for jumphost
  - ðŸŸ©data dir for Jenkins, SonarQube
- ðŸŸ©S3 bucket: must not be public and encrypted with a KMS key.
- ðŸŸ©DNS (Route53): private dns, use domain name for each host
- ðŸŸ©Tagging resources with required tags Group:CyberDevOps, Environment:development
- Following resources are considered non-compliant resources:
  - ðŸŸ©type of EC2, EBS volume, RDS, SG
  - ðŸŸ©not enough required tags
  - ðŸŸ©SG includes 0.0.0.0/0 inbound rule
  - ðŸŸ©S3 bucket is not encrypted by a KMS key
    Use CloudWatch to monitor:
- ðŸŸ©ASG, LB: healthy/unhealthy, latency, number of error requests, etc.
- ðŸŸ©CPU, mem, disk of DB
- ðŸŸ¥SNS: send monitoring alerts (CPU, memory, disk)
- ðŸŸ©Send app logs, app server init logs to CloudWatch
  Build AMI using packer:
- ðŸŸ©Build a golden(base) AMI that is used to build all other AMIs.
- ðŸŸ©Whenever a new golden AMI is released (built), other AMI builds are triggered automatically.
- ðŸŸ©AMIs for Jenkins, Jumphost and app will be built based on the golden AMI.
  App (3-tier model)
- ðŸŸ©Flask API
- Use cloud-init to initialise server
  - ðŸŸ©Check out source code
  - ðŸŸ©Run Docker Compose
- ðŸŸ©Use Python code to export non-compliance security groups
- Build a web page:
  - ðŸŸ©Click the "Scan" button: The app will export the current non-compliant resources to a CSV file
  - ðŸŸ©Store CSV path to DB, and CVS file to S3
  - ðŸŸ©Use S3 presigned URLs with a 12-hour expiration time
  - ðŸŸ©Display the list of exported CSV files
  - ðŸŸ©Click on each CSV file to download
  - ðŸŸ©CSV file name should include a time stamp for easy identification

App pipelines:

- ðŸŸ©Use SonarQube to scan app source code, build Docker image and push to ECR
- ðŸŸ©Deploy new app version (Can use CodeDeploy) => Using terraform, apply new launch template version
  Patching with new base AMI (e.g., by running the terraform pipeline)
- ðŸŸ©Jumphost, ðŸŸ¨Jenkins, ðŸŸ¨app should be patched easily without affecting server data

#### Checklist

ðŸŸ©AMIs are built.
ðŸŸ¨Instances are placed in correct subnets.
ðŸŸ¨Instances are running appropriate AMI.
ðŸŸ¨Can access each instance via SSH.
ðŸŸ©Can access Jenkins, SonarQube, and App ui.
ðŸŸ¨App is functioning correctly.
ðŸŸ¨When auto scaling group launches new app instance, the new instance must have the same app version as the existing ones and it also can process incoming requests.
ðŸŸ¨App CI/CD pipeline can successfully build, test and deploy the app.
ðŸŸ¥Terraform pipeline can plan when git PRs are created and apply changes when PRs are merged.
ðŸŸ¨Can view scan results in SonarQube.
ðŸŸ¨Can update instances' AMIs without losing data.
ðŸŸ¥Appropriate Cloudwatch Alarms are created.
ðŸŸ©Can view app logs in CloudWatch Logs.

### Notes

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)
- Jenkins seedjob flow: JCasC -> Seed Job -> External Job DSLs -> Job groovy scripts
- Terraform ECR Public gets `400` cannot delete if it has images, but can delete whole registry using console
- https://www.reddit.com/r/aws/comments/1ax2zv4/regional_data_transfer_usage_generated_by_ubuntu/
- https://aws.amazon.com/vpc/faqs/#:~:text=two%20instances%20communicate%20using%20public%20IP
- yum mirrors may deny access from some IPs/regions like `seoul`, best to use `sydney` or `singapore`
- AWS's AMI has package mananger source set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound: https://www.reddit.com/r/aws/comments/17s1jsd/comment/ksui2rn/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button

#### Some questions:

- [X] What exactly will EFS store? => Home dir for jumphost, Data dir for Jenkins, SonarQube
- [X] Can Jenkins be deployed in the default VPC? => All Jenkins, App, SonarQube in 1 VPC
- [X] When new code is pushed, how to update ASG? => Create a new launch_template + Instance Refresh / Use CodeDeploy.
- [X] Do we have to register a new domain in Route53? => No, use private DNS and domain name for each host
- [X] What will be the use case of Makefile? => Simplify command execution and automate repetitive tasks
- [X] What AMIs aside from the app AMI should we build from the Base(golden) AMI? => App, Jenkins, Jumphost
- [X] How should the terraform project structure be? => Divide the project into stacks. E.g. Run network stack and use its output for app and jenkins.
- [X] Since the Jenkins master cannot patch its own AMI, what machine will we use to patch it?

- Jenkins patching can be run manually
- All Jenkins, App, SonarQube need to be deployed in 1 VPC. Can use multiple terraform stacks to separate resources like App, Jenkins, Network.
- Focus on patching Jenkins, App, and Jumphost. Don't need to patch NAT Instance, SonarQube
- With multiple stacks/modules, you can take advantage of terraform's `-target` options.

### Old Requirements Notes

#### Mock latest AMI Route

- Route: `/images/aws/centos/latest` returns text/plain the ami-id of the latest HIP AMI.
- Use an S3 static website (manually, not using terraform).
- Point a domain to the site.

#### Mock new build of HIP AMI:

- Build from local machine.
- Packer: Build AMI from centos9, publish AMI and change S3 /images/aws/centos/latest to the new AMI-ID.

#### AMI Build Flow:

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> Other AMIs (Triggered after BASE AMI)

#### Lambda AMI Check

- EventBridge rule triggers Lambda function at some interval.
- Lambda check for compare the latest AMI-ID with the current one (stored in SSM Parameter Store).
- If new AMI-ID is found, trigger Jenkins job to build new Base AMI and update the SSM Parameter Store.

#### Terraform

- Create 2 projects:
  - Jenkins with Lambda, Eventbridge.
  - App: ASG, ALB, RDS, Config, EFS, S3, CloudWatch.

#### Patch app ASG launch template

**On new AMI release:**

- BaseAMI pipeline finished -> Trigger build app AMI pipeline.
- When want to deploy, run PythonAppCD pipeline. Terraform uses AMI datasource and detects change in ami-id -> New launch_template -> ASG Instance Refresh.

**On new code pushed to GitHub:**

- Jenkins pull for GitHub repo changes -> Trigger PythonAppCI pipeline: SonarQube, push to ECR.
- When want to deploy, run PythonAppCD pipeline. Pipeline gets latest commit hash, pass as variable to terraform -> New launch_template -> ASG Instance Refresh.

#### How can app get data about RDS URL, Bucket name?

- Store variables inside SSM Parameter Store.
- In the user-data of EC2, get those variables and export to environment variables.
- Config docker-compose to use env.

#### Jenkins BuildBaseAMI Flow

![build-base-ami-flow](../diagrams/lab-3-build-base-ami.png)

### New Requirement Notes

#### Jenkins Jobs

- **bootstrap**: seed job to create all other jobs
- **Build/BuildBaseAMI(HIP_AMI_ID)**: Triggered by lambda function whenever there is a new HIP AMI-ID.
- **Build/Build{App,Jenkins,Jumphost}AMI**: Triggered automatically after the BuildBaseAMI pipeline successfully finished. Use packer to query the latest BaseAMI and build App/Jenkins/Jumphost AMI.
- **Deploy/Deploy{Jumphost,JenkinsMaster}**: Run terraform, replacing EC2 instances to use laest AMI version.
- **PythonApp/PythonAppCI**: Check GitHub repo changes (pull every 3 hours). If has changes -> clone the source code -> run sonarqube -> build docker image -> push to ECR.
- **PythonApp/PythonAppCD**: Run manually for safety, run terraform apply to deploy new launch template.

#### Enabling Swap can help with memory issue

Tested on t2.micro instance with Jenkins:

- With no swap: Server crashes/stops responding when pipeline runs sonar-scanner node.js step.
- With 2GB swap: Can even run 2 node.js sonar-scanner pipelines concurrently.

#### About EFS

EFS has a free tier of 5GB for Standard storage type.

But throughput can cost alot:

- Elastic throughput: Cost per GB, $0.04 read, $0.07 write
- Provisioned throughput: $7.20 per 1 MB/s per month in Sydney/Singapore region.
- Bursting throughput: Credit based (meaning free?), but only 50KB/s per 1GB data size, which is slow. See `BurstCreditBalance` in CloudWatch Metrics. <== Use this

Every new EFS starts with 2.1TiB of burst credits, confirmed by using CloudWatch:

2308974417330 bytes / 1024 / 1024 / 1024 / 1024 is exactly 2.1TB

![efs_burst_credit_cloudwatch](../diagrams/efs_burst_credit_cloudwatch.png)

Elastic throughput bill for one day setting up Sonarqube server (around 10 times create/destroy data dir): ðŸ˜¥

![efs_bill_elastic](../diagrams/efs_bill_elastic.png)

**Conclusion:** Use Standard EFS with Bursting throughput mode, turn automatic backup off, mount target in the same AZ.

Reference:

- Throughput modes: https://docs.aws.amazon.com/efs/latest/ug/performance.html#throughput-modes
- Pricing (Elastic and Provisioned): https://aws.amazon.com/efs/pricing/

#### Run Flow

- Build HIP, Base AMI manually.
- Build Jenkins, App, Jumphost AMIs manually, these are based on the Base AMI.

#### Other Ideas?

- [X] Write a script to delete all AMIs.
- [X] Show instance-id in frontend to see which instance is receiving the frontend request.
- [ ] Patching Jenkins AMI with low/zero downtime? (Lifecycle hook and provisioner for health check? Or use ASG?)
- [ ] Mount an EBS volume to persist /jenkins_home data, patch Jenkins master using agent.
- [ ] A 404 app page to view 404 request count in dashboard.
- [ ] Split packer, Jenkins jobs to their own separate repository.

#### Journal

This documents the progress and things I learned along the way.

â¬œâœ…

| Date        | Plan                                                                                                                                                                                          | What I Did                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Mon, Apr 1  | âœ…Overview of the lab3's requirements<br />âœ…Refactor the network_interface of the ec2 instances                                                                                              | - Remove all the custom `aws_network_interface` resources                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | - The `aws_instance` by default creates a new ENI for itself, and also receive parameters like `subnet_id`, `security_groups`, `source_dest_check` to configure its ENI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Tue, Apr 2  | âœ…Learn SAA, do practice tests                                                                                                                                                                | - Review SAA learning notes<br />- Review practice tests on udemy<br />- Take official practice exam on SkillBuilder, got 87%                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Wed, Apr 3  | âœ…Refactor VPC modules into one<br />âœ…Automate setting up a Jenkins server<br />âœ…Try out Packer build                                                                                       | - Merge the `vpc_with_nat_instance`Â module into the general `vpc` module.<br />- Write terraform to provision EC2 server for Jenkins<br />- Write user-data script to install Jenkins, plugins and add admin user with JCasC.<br />- Write a `jenkins.pkr.hcl` packer file to build an AMI with Jenkins from a base AMI.<br />- Install `job-dsl` plugin and write a simple seed job.<br />- Config seed job to generate jobs using dsl from git repo                                                                       | - You can conditionally choose to add a terraform resource or not by setting the count to 0 or 1.<br />The tradeoff is that the more you want to customize, the more variables should be added, and the logic is harder to control.<br />- All the Jenkins settingsÂ can be managed in a yaml configuration file using the JCasC plugin.<br />- Instead of directly changing `jenkin.service` systemd file, you can override the config by creating a new file `jenkins.service.d/overrides.conf`<br />- `job-dsl`: Config job using code, job-dsl api page auto reads api of other plugins too.<br />- `startup-trigger-plugin`: Add build trigger to start job on Jenkins startup.<br />- Seed job flow: Jenkins starts -> Load JCasC -> Generate and run seed job `bootstrap` -> Clone repo and run dsl files in `jenkins_jobs` folder to generate jobs/pipelines. (Separate dsl file and pipeline groovy file))                         |
| Thu, Apr 4  | âœ…Init Python app<br />âœ…Test Jenkins with packer                                                                                                                                             | - Create a simple Flask server and run it<br />- Write terraform resources to create EFS<br />- Write a simple job in Jenkins to build jenkins.pkr.hcl<br />- Add packer needed policies to ec2_jenkins_role                                                                                                                                                                                                                                                                                                                         | - Flask has `--debug` flag for hot reload<br />- Jenkins plugin `ansi-color`: Console Output with color<br />- RHEL and Centos has a binary in PATH that is coincidentally also named `packer` , so I have to move it away to use packer by Hashicorp<br />- `hash -r` command: clear the hash table, which `which` command uses                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Fri, Apr 5  | âœ…Add lab3's diagram<br />âœ…Dockerize the python app                                                                                                                                          | - Add a overview diagram of lab3Â with all the services<br />- Create a public ECR registry<br />- Write Dockerfile and docker-compose.yml<br />- Manually upload docker image to registry                                                                                                                                                                                                                                                                                                                                           | -Â Terraform ECR Public gets code 400 cannot delete registry if it has images, but you can delete whole registry manually using console.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Sat, Apr 6  |                                                                                                                                                                                               | - Registered for the SAA exam on Monday, 08/04/2024                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Mon, Apr 8  | âœ…Review and Take SAA test                                                                                                                                                                    | - Review the practice exams, notes.<br />- Sit the test in the afternoon. Got result at night, passed with the score of 853.                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Tue, Apr 9  | âœ…Finish lab2<br />âœ…Connect lab3 app to mock SQLite db                                                                                                                                       | - Lab2: Limit SG rules, add tags to resources<br />- Change AMI used to CentOS-Stream-9<br />- AddÂ DynamoDB state lock in terraform.<br />- Refactor ec2_profile into a module.<br />- Add flask_sqlalchemy to the app.                                                                                                                                                                                                                                                                                                             | - To use `ip route add`Â to route through NAT Instance, the NAT Instance must have another network interface (with source-dest-check off) inside the **same subnet** as the EC2 instance.<br />- RHEL AMIÂ has package manager repoÂ set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound => Good to know but should not matter that much.<br />-Â The `http_proxy` environment variable is a way to tell applications that they should use a specific proxy server when making HTTP requests. However, it's up to each individual application to respect this setting.                                                                                                                                                                                                                                                                                                  |
| Wed, Apr 10 | âœ…Add EventBridge + Lambda triggering Jenkins job<br />âœ…Jenkins job to build and publish Docker image.                                                                                       | - Try to mock HIPÂ HTTP route `/images/aws/centos/latest` using API Gateway REST API => HardÂ to setup/modify<br />=>Â Decided to useÂ S3 static website and custom domain name.<br />- Write Lambda function to compare the latest AMI and the current AMI, trigger Jenkins build if different.<br />- Write terraform resources for EventBridge to trigger Lambda at some interval.<br />- Move Python app to a separate git repo.<br />- Add PythonAppCI job to build, tag and push image to ECR.                               | - Jenkins `build-token-root` plugin: Trigger job build through an URL with token without authenticatingÂ user.<br />- Jenkins does not support Subfolder git tracking by default, so moved app to a different repo to manage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Thu, Apr 11 | âœ…Integrate Jenkins with SonarQube<br />âœ…Add SonarQubeÂ to App CI pipeline<br />â¬œ~Add terraform AWS Config~                                                                                | - Registered for a SonarCloud server, add a new project, generate a user token.<br />- Install the SonarQube Scanner plugin, config with JCasC<br />- Add sonar-scanner to app pipeline.<br />- Add packer file to build mockÂ HIP Base AMI.<br />- Move Jenkins to default region VPC.<br />- Write terraform resources for AWS Config. Currently not working, enabling Recorder hangs.                                                                                                                                             | - The AMI build flow:Â HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)<br />- Packer has `post-processor` to run command => Read created ami-id and push to S3 mock HIP server.<br />- AWS Config in terraform:Â `Recorder` needs `Delivery channel` to start, but `Delivery channel` needs `Recorder` to be created.Â <br />=> `aws_config_configuration_recorder_status` resource set to true to enable recorder                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Fri, Apr 12 | âœ…Review and demo Lab2<br />âœ…Setup React frontend for app                                                                                                                                    | - Init React client with tailwind.<br />- Flask to serve static files generated by React build.                                                                                                                                                                                                                                                                                                                                                                                                                                      | - If you use proxy environments like `HTTP_PROXY` on EC2, set `NO_PROXY` to include `169.254.169.254` for IMDS access.<br />- `traceroute` on linux uses UDP by default, but can be switched to using ICMP ECHO using `-I` option.<br />- App Development: 2 servers React and Flask API.<br />- App Deploy: Flask serves bothÂ React static file and API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Mon, Apr 15 | âœ…Document the notes<br />âœ…Add terraform AWS Config, S3 for app<br />âœ…Use boto3 to call configservice api                                                                                   | - Build and add course learning notes to github pages using Docusaurus.<br />- Add needed policies for AWS Config to use S3 bucket.<br />- Use boto3 to: Get all the SG in a region, check compliance status with AWS Config, export to CSV files and upload to S3, generate presigned URLs to download.<br />- Integrate into the Flask API.<br />- Create React frontend to consume API.                                                                                                                                           | - Configuration Recorder records configs changes and creates a Configuration ItemÂ for each change. 1 change == 1 CI<br />- Rules useÂ CI to evaluate compliance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Tue, Apr 16 | âœ…Dockerize Python app with API and Web<br />âœ…Draw the flow of the pipeline build BaseAMI<br />âœ…Write a script to delete all AMI                                                            | - Update Dockerfile, use multi-stage to build React web, copy static files to python app.<br />- Add `.dockerignore` node_modules, build to reduce image size.<br />- Add diagram for Jenkins Job: BuildBaseAMI<br />- Write job BuildBaseAMI in Jenkins. Trigger with Lambda.                                                                                                                                                                                                                                                     | - In .gitignore, a relative path (e.g.`filename`) matches the path under any directory, while in .dockerignore it's `**/filename`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Wed, Apr 17 | âœ…Find a way to run Jenkins with master + agent setup                                                                                                                                         | - Add Jenkins Amazon EC2 plugin, config to auto spawn agent.<br />- Dump config to JCasC.                                                                                                                                                                                                                                                                                                                                                                                                                                            | - EC2 plugin requires correct AWS Key Pair format ("-----BEGIN RSA PRIVATE KEY-----")<br />`aws ec2 create-key-pair --key-name my-key-pair --key-type rsa --key-format pem --query "KeyMaterial" --output text > my-key-pair.pem`<br />- Generate public key from private key with `ssh-keygen -y [-f input_keyfile]`<br />- You can addÂ label to nodes, and then specify label in job to run on which node.<br />- You can config EC2 so that there is always a number of instances standing by waiting for jobs.                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Fri, Apr 19 | âœ…Write terraform for Python App infrastructure: ALB, ASG, RDS                                                                                                                                | - Create RDS instance with terraform.<br />- Create ALB, ASG with Launch Template.<br />- Write app user-data to auto clone github repo and run docker compose.                                                                                                                                                                                                                                                                                                                                                                      | - You cannot directly specify a subnet forÂ RDS, instead create a `subnet group` first then assign to the RDS instance.<br />- You'll need at least two subnets in two different availability zones since RDS required this for Multi-AZ mainly.<br />- You need to do this even for Single-AZ deployments, just in case you want to convert them to Multi-AZ deployments at some point.<br />- [Docker compose env precedence](https://docs.docker.com/compose/environment-variables/envvars-precedence/), docker compose also reads from .env file.<br />- ALB also requires at least 2 subnets in 2 AZs.<br />- `security_groups` argument of resource `aws_instance` is for default VPC only, use `vpc_security_group_ids` instead. The first one will force replacement everyÂ terraform apply.<br />- Default SQLAlchemy engine may not work with mysql. Use `pymysql` and use URI like `mysql+pymysql://user:pass@db.com:3306/db_name.` |
| Mon, Apr 22 | âœ… ASG + ELB Health checks<br />âœ… Rolling Update ASG with new launch template (new AMI/Code)<br />âœ… Update appÂ to use boto3 SSM instead of injecting directly from terraform to user-data. | -Â FixÂ route table terraform reapply issues.<br />- Add AWS managed `required-tags` rule to check resources tags.<br />- Update SG compliance check method: Get all rules for SG,Â <br />then call API for each rule instead of calling API for each SG like currently implemented.<br />- Add HTTP health check route in python app, use ELB as health check for ASG.<br />- Rolling update ASG using Instance refresh with terraform.<br />- Add BuildAppAMI jenkins job. Trigger when BuildBaseAMI job completed successfully. | - You can only use either inline route or standalone `aws_route` resource, using both will cause them to override and conflict.<br />- Don't need to add resource for the default local route.<br />- Use terraform lifecycle for SSM Parameter toÂ not reapply the value if it changes.<br />- ALB Target Group has HTTP health check, and ASG can also use this ELB health check to replace unhealthy instances instead of the default EC2 health check.<br />- Set ASG health check grace period to prevent ASG from terminating an instance on launch if the ELB health check fails.                                                                                                                                                                                                                                                                                                                                                              |
| Tue, Apr 23 | âœ… Jenkins job to deploy/apply new app AMI/Code version.<br />âœ… Show instance-id in frontend to see which instance is receiving the frontend request                                         | - Add PythonAppCD job: Plan and apply terraform to update auto scaling group launch template.<br />- Optimize Dockerfile: Combine RUN steps, add `.git`, `node_modules`,.. to .dockerignore.<br />- Show instance-id in frontend: Change start command in Dockerfile to a custom script, check if machine is EC2,<br />then change INSTANCE_ID placeholder to the real instance id.<br />- Refactor resource names to follow conventions.                                                                                        | - New code pushed to GitHub -> Jenkins get the latest commit hash -> Apply to terraform launch_template tag to check if different -> Update launch_template version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|             | Lab 3 requirements changed.                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Wed, Apr 24 | âœ… SeeÂ the changes in lab3's requirement.<br />âœ… Write down questions if have any.                                                                                                          | - Create a new project folder for lab 3, use a main file at root folder and modules in subfolders.<br />- Create a main VPC for infrastructure.<br />- Create ALB + Jenkins setup, reusing most of the code to initialize Jenkins.<br />- Migrate App ASG+ALB to new labÂ module.<br />- Create EFS module with mount target.                                                                                                                                                                                                        | - With multiple stacks/modules, you can take advantage of terraform's `-target` options to only apply/destroy certain resources/modules.<br />- Can generate a random password for RDS using terraform `random_password` resource.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Thu, Apr 25 | âœ… Rewrite the app to check resources and evaluate rules using Python instead of Config.                                                                                                      | - Add a route to scan for resources and check them against custom rules.<br />- Update frontend to work with new API.                                                                                                                                                                                                                                                                                                                                                                                                                | - Flow: Get all resources (EC2, RDS, S3, EBS, SG), run them through each associated rule, add a description for every unmatched rule.<br />- Add ExpiresIn parameter for generating pre-signed S3 URL.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Fri, Apr 26 | âœ… Automate creation ofÂ the SonarQube server.                                                                                                                                                | - Write user-data to install SonarQube<br />- Mount EFS volume, restore default seed data from S3.<br />- Load sonarqube_tokenÂ from SSM with /run/secrets/secrets.properties file instead of passing in yaml config directly.<br />- Create a VPC Gateway Endpoint for S3.                                                                                                                                                                                                                                                          | - SonarQube data is stored at `$SONAR_HOME/data`<br />- Can run SonarQube for development with embedded H2 database, you'll see a warning message in the logs, and SonarQube will not start in production mode.<br />- To escape \${} in terraform template file, use \$\${}<br />- VPC Gateway Endpoint helps reduce internet traffic to S3, and it's free.<br />- VPC Gateway Endpoint works by creating a route in the route tables, pointing a `prefix list` (containing S3's IP ranges) to the gateway endpoint.                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Mon, Apr 29 | âœ… Mount Jenkins home folder to EFS. Manually update Jenkins without losing data.<br />âœ… Rewrite deploy app pipeline with new terraform structure.                                           | - Add user-data script for Jenkins to mount EFS, init home dir if not exist.<br />- Add 1 day stickiness to app ALB target group.<br />- Group Jenkins jobs into folders.<br />- Add jobs to build Jenkins and Jumphost AMI.<br />- Add a Makefile for Python App development commands.                                                                                                                                                                                                                                              | - Use EFS with bursting throughput to optimize cost, the 2.1TB credit isÂ enough for the workload of the lab.<br />- ALB stickiness can help with rolling update by avoiding a case where an user can see 2 versions of the app when refreshing the page.<br />- Increase Jenkins numExecutors to 3 to build 3 AMIs concurrently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Thu, May 2  | âœ… Create Jumphost with terraform.<br />âœ… Build/Deploy Jumphost AMI pipeline.                                                                                                                | - Create a terraform module for jumphost instance.<br />- Create DeployJumphost job in Jenkins.<br />- Run Jenkins jobs on EC2 agent, except for bootstrap job.<br />- Create DeployJenkinsMaster job, run on agent.                                                                                                                                                                                                                                                                                                                 | - Terraform will not destroyÂ EC2 agents that are spawned using EC2 plugin. So need to manually terminate them after running terraform destroy.<br />- Use `create_before_destroy` lifecycle to reduce some downtime.<br />- When Jenkins master is being patched, the agent can still run job and connect back to master when it's up again.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Fri, May 3  | âœ… Mount EFS as home dir for jump host.<br />âœ… Create CloudWatch metrics dashboard                                                                                                           | - Mount EFS on Jumphost, create some test users using user-data.<br />- Allow pubkey ssh login for test users, and sudo privilege.<br />- Add dashboard to monitor app ALB, RDS, export to terraform template file.<br />- Send PythonAppLog, cloud-init-output to CloudWatch Logs.                                                                                                                                                                                                                                                  | - In CentOS there is a default `wheel` group, add users to this group for sudo privileges.<br />- Need to `setsebool -P use_nfs_home_dirs 1` for sshd to be able to read authorized_keys in nfs mount.<br />- Create dashboard with metrics -> Actions/View source -> Copy to terraform template.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Mon, May 6  | âœ… Connect App CI to SonarQube server.<br />âœ… Add KMS for S3.<br />âœ… Add scaling policy to ASG.                                                                                             | - Change JCasC config and credentials to SonarQube server instead of SonarCloud.<br />- Add terraform for KMS, KMS policy for ASG<br />- Add `aws_autoscaling_policy` target tracking to scale out ASG when ASGCpuUtilization is more than 50%.                                                                                                                                                                                                                                                                                    | - SonarQube quality check requires a webhook to Jenkins. A workaround is to timeout the `waitForQualityGate()` function every few seconds and retry.<br />- Use signature v4 for S3 boto3.<br />- Using S3 with KMS, boto3 get_presigned_url got `SignatureDoesNotMatch` error => Add endpoint_url="https://s3.ap-southeast-1.amazonaws.com" to boto3 s3 client.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Tue, May 7  | âœ… Log Stream for each instance, log agent from base AMI.<br />âœ… Create Route53 private hosted zone, assign domain name for hosts.                                                           | - Moved CloudWatch agent config json to App AMI.<br />- Create Route53 hosted zone using terraform, add domain name `rds.go` `sonarqube.go` `jenkins.go`.                                                                                                                                                                                                                                                                                                                                                                      | - Seems like there is no ALIAS record for EC2 Instance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|             | - Restrict security groups.<br />- SNS Alerts - Optional<br />- Terraform pipepline.                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|             |                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
