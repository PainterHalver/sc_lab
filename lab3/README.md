# Checklist

#### Old Requirements

ðŸŸ©Use Terraform
ðŸŸ¥Use Makefile
ðŸŸ©Setup Jenkins for CI/CD
ðŸŸ©Build AMI using packer
ðŸŸ©Build a BASE AMI that is used to build all other AMIs
Whenever a new base AMI is released (built), other AMI builds are triggered automatically
ðŸŸ©Use lambda function to check source AMI and trigger Jenkins pipelines
ðŸŸ¨Create EFS: as persistant data storage, store source code or app data permanently

ðŸŸ¨App (3-tier model)
Flask API
user-data: Auto mount EFS
Run Docker Compose
Use Boto3, pandas(export CSV)... to export non-compliance security groups (Webpage > Click a button > List URLs to download CSV files)
ðŸŸ©Store CSV lists to DB
App pipelines:

- Build Docker image â†’ ECR
- ðŸŸ¨ Use SonarQube to scan source code.
- ðŸŸ¨ Deploy new app version
- ðŸŸ¨ Patching with new base AMI

ðŸŸ©Tagging resources with required tags
Group: CyberDevOps
Environment: development

ðŸŸ©AWS Config:
Rule to check tag compliance
Rule to check SG rule compliance
ðŸŸ¨SNS: send monitoring alerts (CPU, memory, disk)
ðŸŸ¨DNS (Route53)
ðŸŸ©ALB
ðŸŸ©ASG
ðŸŸ©RDS
ðŸŸ©S3 (CSV files)
ðŸŸ¨Encrypted with KMS key

#### New Requirements

### Notes

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)
- Jenkins seedjob flow: JCasC -> Seed Job -> External Job DSLs -> Job groovy scripts
- Terraform ECR Public gets `400` cannot delete if it has images, but can delete whole registry using console
- https://www.reddit.com/r/aws/comments/1ax2zv4/regional_data_transfer_usage_generated_by_ubuntu/
- https://aws.amazon.com/vpc/faqs/#:~:text=two%20instances%20communicate%20using%20public%20IP
- yum mirrors may deny access from some IPs/regions like `seoul`, best to use `sydney` or `singapore`
- AWS's AMI has package mananger source set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound: https://www.reddit.com/r/aws/comments/17s1jsd/comment/ksui2rn/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button

#### EFS + DockerCompose?

- UserData Script to clone github repo and run docker compose -> Pull and run image from ECR
- Docker compose mount EFS volume to store data/logs??

```yaml
# Example
version: "3"
services:
  web:
    image: my-web-app:latest
    environment:
      - DATABASE_URL=postgres://user:password@my-rds-endpoint:5432/mydatabase
    volumes:
      - efs:/var/www/html

volumes:
  efs:
    driver: local
    driver_opts:
      type: nfs
      o: addr=my-efs-endpoint,nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
      device: :/
```

#### Some questions:

- [X] What exactly will EFS store? => Home dir for jumphost, Data dir for Jenkins, SonarQube
- [X] Can Jenkins be deployed in the default VPC? => All Jenkins, App, SonarQube in 1 VPC
- [X] When new code is pushed, how to update ASG? => Create a new launch_template + Instance Refresh / Use CodeDeploy.
- [X] Do we have to register a new domain in Route53? => No, use private DNS and domain name for each host
- [X] What will be the use case of Makefile? => Simplify command execution and automate repetitive tasks
- [X] What AMIs aside from the app AMI should we build from the Base(golden) AMI? => App, Jenkins, Jumphost
- [X] How should the terraform project structure be? => Divide the project into stacks. E.g. Run network stack and use its output for app and jenkins.
- [ ] Since the Jenkins master cannot patch its own AMI, what machine will we use to patch it?

- Jenkins patching can be run manually
- All Jenkins, App, SonarQube need to be deployed in 1 VPC. Can use multiple terraform stacks to separate resources like App, Jenkins, Network.
- Focus on patching Jenkins, App, and Jumphost. Don't need to patch NAT Instance, SonarQube
- With multiple stacks/modules, you can take advantage of terraform's `-target` options.

#### Mock latest AMI Route

- Route: `/images/aws/centos/latest` returns text/plain the ami-id of the latest HIP AMI.
- Use an S3 static website (manually, not using terraform).
- Point a domain to the site.

#### Mock new build of HIP AMI:

- Build from local machine.
- Packer: Build AMI from centos9, publish AMI and change S3 /images/aws/centos/latest to the new AMI-ID.

#### AMI Build Flow:

- HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> Other AMIs (Triggered after BASE AMI)

#### Lambda AMI Check

- EventBridge rule triggers Lambda function at some interval.
- Lambda check for compare the latest AMI-ID with the current one (stored in SSM Parameter Store).
- If new AMI-ID is found, trigger Jenkins job to build new Base AMI and update the SSM Parameter Store.

#### Terraform

- Create 2 projects:
  - Jenkins with Lambda, Eventbridge.
  - App: ASG, ALB, RDS, Config, EFS, S3, CloudWatch.

#### Patch app ASG launch template

**On new AMI release:**

- BaseAMI pipeline finished -> Trigger build app AMI pipeline.
- When want to deploy, run PythonAppCD pipeline. Terraform uses AMI datasource and detects change in ami-id -> New launch_template -> ASG Instance Refresh.

**On new code pushed to GitHub:**

- Jenkins pull for GitHub repo changes -> Trigger PythonAppCI pipeline: SonarQube, push to ECR.
- When want to deploy, run PythonAppCD pipeline. Pipeline gets latest commit hash, pass as variable to terraform -> New launch_template -> ASG Instance Refresh.

#### How can app get data about RDS URL, Bucket name?

- Store variables inside SSM Parameter Store.
- In the user-data of EC2, get those variables and export to environment variables.
- Config docker-compose to use env.

#### Jenkins Jobs

- **bootstrap**: seed job to create all other jobs
- **BuildBaseAMI(HIP_AMI_ID)**: Triggered by lambda function whenever there is a new HIP AMI-ID.
- **BuildAppAMI**: Triggered automatically after the BuildBaseAMI pipeline successfully finished. Use packer to query the latest BaseAMI and build App AMI.
- **PythonAppCI**: Check GitHub repo changes (pull every 3 hours). If has changes -> clone the source code -> run sonarqube -> build docker image -> push to ECR.
- **PythonAppCD**: Run manually for safety, run terraform apply to deploy new launch template.

#### Jenkins BuildBaseAMI Flow

![build-base-ami-flow](../diagrams/lab-3-build-base-ami.png)

#### Other Ideas?

- [X] Write a script to delete all AMIs.
- [X] Show instance-id in frontend to see which instance is receiving the frontend request.
- [ ] Mount an EBS volume to persist /jenkins_home data, patch Jenkins master using agent.

#### Journal

This documents the progress and things I learned along the way.

â¬œâœ…

| Date        | Plan                                                                                                                                                                                          | What I Did                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Mon, Apr 1  | âœ…Overview of the lab3's requirements<br />âœ…Refactor the network_interface of the ec2 instances                                                                                              | - Remove all the custom `aws_network_interface` resources                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | - The `aws_instance` by default creates a new ENI for itself, and also receive parameters like `subnet_id`, `security_groups`, `source_dest_check` to configure its ENI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Tue, Apr 2  | âœ…Learn SAA, do practice tests                                                                                                                                                                | - Review SAA learning notes<br />- Review practice tests on udemy<br />- Take official practice exam on SkillBuilder, got 87%                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Wed, Apr 3  | âœ…Refactor VPC modules into one<br />âœ…Automate setting up a Jenkins server<br />âœ…Try out Packer build                                                                                       | - Merge the `vpc_with_nat_instance`Â module into the general `vpc` module.<br />- Write terraform to provision EC2 server for Jenkins<br />- Write user-data script to install Jenkins, plugins and add admin user with JCasC.<br />- Write a `jenkins.pkr.hcl` packer file to build an AMI with Jenkins from a base AMI.<br />- Install `job-dsl` plugin and write a simple seed job.<br />- Config seed job to generate jobs using dsl from git repo                                                                       | - You can conditionally choose to add a terraform resource or not by setting the count to 0 or 1.<br />The tradeoff is that the more you want to customize, the more variables should be added, and the logic is harder to control.<br />- All the Jenkins settingsÂ can be managed in a yaml configuration file using the JCasC plugin.<br />- Instead of directly changing `jenkin.service` systemd file, you can override the config by creating a new file `jenkins.service.d/overrides.conf`<br />- `job-dsl`: Config job using code, job-dsl api page auto reads api of other plugins too.<br />- `startup-trigger-plugin`: Add build trigger to start job on Jenkins startup.<br />- Seed job flow: Jenkins starts -> Load JCasC -> Generate and run seed job `bootstrap` -> Clone repo and run dsl files in `jenkins_jobs` folder to generate jobs/pipelines. (Separate dsl file and pipeline groovy file))                         |
| Thu, Apr 4  | âœ…Init Python app<br />âœ…Test Jenkins with packer                                                                                                                                             | - Create a simple Flask server and run it<br />- Write terraform resources to create EFS<br />- Write a simple job in Jenkins to build jenkins.pkr.hcl<br />- Add packer needed policies to ec2_jenkins_role                                                                                                                                                                                                                                                                                                                         | - Flask has `--debug` flag for hot reload<br />- Jenkins plugin `ansi-color`: Console Output with color<br />- RHEL and Centos has a binary in PATH that is coincidentally also named `packer` , so I have to move it away to use packer by Hashicorp<br />- `hash -r` command: clear the hash table, which `which` command uses                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Fri, Apr 5  | âœ…Add lab3's diagram<br />âœ…Dockerize the python app                                                                                                                                          | - Add a overview diagram of lab3Â with all the services<br />- Create a public ECR registry<br />- Write Dockerfile and docker-compose.yml<br />- Manually upload docker image to registry                                                                                                                                                                                                                                                                                                                                           | -Â Terraform ECR Public gets code 400 cannot delete registry if it has images, but you can delete whole registry manually using console.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Sat, Apr 6  |                                                                                                                                                                                               | - Registered for the SAA exam on Monday, 08/04/2024                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Mon, Apr 8  | âœ…Review and Take SAA test                                                                                                                                                                    | - Review the practice exams, notes.<br />- Sit the test in the afternoon. Got result at night, passed with the score of 853.                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Tue, Apr 9  | âœ…Finish lab2<br />âœ…Connect lab3 app to mock SQLite db                                                                                                                                       | - Lab2: Limit SG rules, add tags to resources<br />- Change AMI used to CentOS-Stream-9<br />- AddÂ DynamoDB state lock in terraform.<br />- Refactor ec2_profile into a module.<br />- Add flask_sqlalchemy to the app.                                                                                                                                                                                                                                                                                                             | - To use `ip route add`Â to route through NAT Instance, the NAT Instance must have another network interface (with source-dest-check off) inside the **same subnet** as the EC2 instance.<br />- RHEL AMIÂ has package manager repoÂ set to AWS's own mirror, which will cost REGIONAL DATA TRANSFER as opposed to using public mirrors, which is free inbound => Good to know but should not matter that much.<br />-Â The `http_proxy` environment variable is a way to tell applications that they should use a specific proxy server when making HTTP requests. However, it's up to each individual application to respect this setting.                                                                                                                                                                                                                                                                                                  |
| Wed, Apr 10 | âœ…Add EventBridge + Lambda triggering Jenkins job<br />âœ…Jenkins job to build and publish Docker image.                                                                                       | - Try to mock HIPÂ HTTP route `/images/aws/centos/latest` using API Gateway REST API => HardÂ to setup/modify<br />=>Â Decided to useÂ S3 static website and custom domain name.<br />- Write Lambda function to compare the latest AMI and the current AMI, trigger Jenkins build if different.<br />- Write terraform resources for EventBridge to trigger Lambda at some interval.<br />- Move Python app to a separate git repo.<br />- Add PythonAppCI job to build, tag and push image to ECR.                               | - Jenkins `build-token-root` plugin: Trigger job build through an URL with token without authenticatingÂ user.<br />- Jenkins does not support Subfolder git tracking by default, so moved app to a different repo to manage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Thu, Apr 11 | âœ…Integrate Jenkins with SonarQube<br />âœ…Add SonarQubeÂ to App CI pipeline<br />â¬œ~Add terraform AWS Config~                                                                                | - Registered for a SonarCloud server, add a new project, generate a user token.<br />- Install the SonarQube Scanner plugin, config with JCasC<br />- Add sonar-scanner to app pipeline.<br />- Add packer file to build mockÂ HIP Base AMI.<br />- Move Jenkins to default region VPC.<br />- Write terraform resources for AWS Config. Currently not working, enabling Recorder hangs.                                                                                                                                             | - The AMI build flow:Â HIP baseAMI (simulate manually) -> Our BASE AMI (triggered by Lambda) -> App/Jenkins AMI (Triggered after BASE AMI)<br />- Packer has `post-processor` to run command => Read created ami-id and push to S3 mock HIP server.<br />- AWS Config in terraform:Â `Recorder` needs `Delivery channel` to start, but `Delivery channel` needs `Recorder` to be created.Â <br />=> `aws_config_configuration_recorder_status` resource set to true to enable recorder                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Fri, Apr 12 | âœ…Review and demo Lab2<br />âœ…Setup React frontend for app                                                                                                                                    | - Init React client with tailwind.<br />- Flask to serve static files generated by React build.                                                                                                                                                                                                                                                                                                                                                                                                                                      | - If you use proxy environments like `HTTP_PROXY` on EC2, set `NO_PROXY` to include `169.254.169.254` for IMDS access.<br />- `traceroute` on linux uses UDP by default, but can be switched to using ICMP ECHO using `-I` option.<br />- App Development: 2 servers React and Flask API.<br />- App Deploy: Flask serves bothÂ React static file and API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Mon, Apr 15 | âœ…Document the notes<br />âœ…Add terraform AWS Config, S3 for app<br />âœ…Use boto3 to call configservice api                                                                                   | - Build and add course learning notes to github pages using Docusaurus.<br />- Add needed policies for AWS Config to use S3 bucket.<br />- Use boto3 to: Get all the SG in a region, check compliance status with AWS Config, export to CSV files and upload to S3, generate presigned URLs to download.<br />- Integrate into the Flask API.<br />- Create React frontend to consume API.                                                                                                                                           | - Configuration Recorder records configs changes and creates a Configuration ItemÂ for each change. 1 change == 1 CI<br />- Rules useÂ CI to evaluate compliance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Tue, Apr 16 | âœ…Dockerize Python app with API and Web<br />âœ…Draw the flow of the pipeline build BaseAMI<br />âœ…Write a script to delete all AMI                                                            | - Update Dockerfile, use multi-stage to build React web, copy static files to python app.<br />- Add `.dockerignore` node_modules, build to reduce image size.<br />- Add diagram for Jenkins Job: BuildBaseAMI<br />- Write job BuildBaseAMI in Jenkins. Trigger with Lambda.                                                                                                                                                                                                                                                     | - In .gitignore, a relative path (e.g.`filename`) matches the path under any directory, while in .dockerignore it's `**/filename`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Wed, Apr 17 | âœ…Find a way to run Jenkins with master + agent setup                                                                                                                                         | - Add Jenkins Amazon EC2 plugin, config to auto spawn agent.<br />- Dump config to JCasC.                                                                                                                                                                                                                                                                                                                                                                                                                                            | - EC2 plugin requires correct AWS Key Pair format ("-----BEGIN RSA PRIVATE KEY-----")<br />`aws ec2 create-key-pair --key-name my-key-pair --key-type rsa --key-format pem --query "KeyMaterial" --output text > my-key-pair.pem`<br />- Generate public key from private key with `ssh-keygen -y [-f input_keyfile]`<br />- You can addÂ label to nodes, and then specify label in job to run on which node.<br />- You can config EC2 so that there is always a number of instances standing by waiting for jobs.                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Fri, Apr 19 | âœ…Write terraform for Python App infrastructure: ALB, ASG, RDS                                                                                                                                | - Create RDS instance with terraform.<br />- Create ALB, ASG with Launch Template.<br />- Write app user-data to auto clone github repo and run docker compose.                                                                                                                                                                                                                                                                                                                                                                      | - You cannot directly specify a subnet forÂ RDS, instead create a `subnet group` first then assign to the RDS instance.<br />- You'll need at least two subnets in two different availability zones since RDS required this for Multi-AZ mainly.<br />- You need to do this even for Single-AZ deployments, just in case you want to convert them to Multi-AZ deployments at some point.<br />- [Docker compose env precedence](https://docs.docker.com/compose/environment-variables/envvars-precedence/), docker compose also reads from .env file.<br />- ALB also requires at least 2 subnets in 2 AZs.<br />- `security_groups` argument of resource `aws_instance` is for default VPC only, use `vpc_security_group_ids` instead. The first one will force replacement everyÂ terraform apply.<br />- Default SQLAlchemy engine may not work with mysql. Use `pymysql` and use URI like `mysql+pymysql://user:pass@db.com:3306/db_name.` |
| Mon, Apr 22 | âœ… ASG + ELB Health checks<br />âœ… Rolling Update ASG with new launch template (new AMI/Code)<br />âœ… Update appÂ to use boto3 SSM instead of injecting directly from terraform to user-data. | -Â FixÂ route table terraform reapply issues.<br />- Add AWS managed `required-tags` rule to check resources tags.<br />- Update SG compliance check method: Get all rules for SG,Â <br />then call API for each rule instead of calling API for each SG like currently implemented.<br />- Add HTTP health check route in python app, use ELB as health check for ASG.<br />- Rolling update ASG using Instance refresh with terraform.<br />- Add BuildAppAMI jenkins job. Trigger when BuildBaseAMI job completed successfully. | - You can only use either inline route or standalone `aws_route` resource, using both will cause them to override and conflict.<br />- Don't need to add resource for the default local route.<br />- Use terraform lifecycle for SSM Parameter toÂ not reapply the value if it changes.<br />- ALB Target Group has HTTP health check, and ASG can also use this ELB health check to replace unhealthy instances instead of the default EC2 health check.<br />- Set ASG health check grace period to prevent ASG from terminating an instance on launch if the ELB health check fails.                                                                                                                                                                                                                                                                                                                                                              |
| Tue, Apr 23 | âœ… Jenkins job to deploy/apply new app AMI/Code version.<br />âœ… Show instance-id in frontend to see which instance is receiving the frontend request                                         | - Add PythonAppCD job: Plan and apply terraform to update auto scaling group launch template.<br />- Optimize Dockerfile: Combine RUN steps, add `.git`, `node_modules`,.. to .dockerignore.<br />- Show instance-id in frontend: Change start command in Dockerfile to a custom script, check if machine is EC2,<br />then change INSTANCE_ID placeholder to the real instance id.<br />- Refactor resource names to follow conventions.                                                                                        | - New code pushed to GitHub -> Jenkins get the latest commit hash -> Apply to terraform launch_template tag to check if different -> Update launch_template version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|             | Lab 3 requirements changed.                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Wed, Apr 24 | âœ… SeeÂ the changes in lab3's requirement.<br />âœ… Write down questions if have any.                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
